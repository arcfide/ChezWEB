% These macros are designed to support ChezWEB woven programs.
% Version: 0.1
% 
% Copyright (c) 2010 Aaron W. Hsu <arcfide@sacrideo.us>
% 
% Permission to use, copy, modify, and distribute this software for
% any purpose with or without fee is hereby granted, provided that the
% above copyright notice and this permission notice appear in all
% copies.
% 
% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
% WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
% WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
% AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
% DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA
% OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
% TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
% PERFORMANCE OF THIS SOFTWARE.

\font\titlef = cmr17
\font\small = cmr8
\font\smallit = cmti8
\font\smalltt = cmtt8

\input eplain

\newcount\sectc

\long\def\rendertoc{%
  \centerline{\bf Contents}\par
  \begingroup
    \leftskip = .5in
    \rightskip = .5in
    \parindent = 0pt
    \readtocfile
    \par
  \endgroup
  \bigskip}

\def\sect{%
  \advance\sectc by 1
  {\noindent\bf\the\sectc . }}
\def\endsect{\medskip}

\def\nsect#1#2{%
  \advance\sectc by 1
  \writenumberedtocentry{section}{#2}{\the\sectc}
  {\noindent\bf\the\sectc . #2.} }
\def\endnsect{\medskip}

\def\tocsectionentry#1#2#3{%
  {\sl #1}\dotfill \S #2 p. #3\break}

%% Some uber cool blank testing stuff
% Usage: \if\blank{#1}...\else...\fi

\catcode`\@=11 % as in plain.tex
\long\def\blank#1{\bl@nk#1@@..\bl@nk}%
\long\def\bl@nk#1#2@#3#4\bl@nk{#3#4}
\catcode`\@=12

\long\def\test#1{\begingroup \toks0{[#1]}%
  \newlinechar`\/\message{/\the\toks0:
    \if\blank{#1}EMPTY\else NOT empty\fi%
    }\endgroup}

% We need to be able to create a verbatim environment that allows
% macro and commands to be run.

\def\chunkxref{}

\def\chunk#1#2{%
  \bgroup
  \hfil\break$\langle$#1$\rangle \equiv$
  \definexref{#2}{\the\sectc}{chunkxref}  
  \ttverbatim}
\def\chunkinterface{%
  \endgroup\begingroup\parindent = 0in\smalltt\raggedright}
\def\endchunkinterface{\endgroup}
\def\chunkimports{%
  \smallskip{\smallit Imports: }}
\def\chunkexports{%
  \smallskip{\smallit Exports: }}
\def\chunkcaptures{%
  \smallskip{\smallit Captures: }}
\def\endchunk{%
  \egroup}

\def\code{%
  \bgroup
  \hfil\break$\langle * \rangle \equiv$
  \ttverbatim}
\def\endcode{\endgroup\egroup}

\def\x#1;{\char"#1 }

\def\chunkref#1#2{%
  $\langle${\rm #1 \refn{#2}}$\rangle$}

\long\def\library#1{%
  \vfil\break
  \centerline{\bf Library Definition: #1}\medskip}

\def\export{%
  \def\endexport{\endgroup}
  \noindent{\bf Exports:}\par\begingroup\tt}
\def\import{%
  \def\endimport{\endgroup}
  \noindent{\bf Imports:}\par\begingroup\tt}

\def\endlibrary#1{%
  \medskip\noindent
  {\small This concludes the definition of #1.}\vfill\break}

%   ttbar.tex
 
 
% Lifted from TUGBOT.STY.
%
%       Support verbatim listing of TeX source, as defined in TeXbook, p. 421;
%       lifted from MANMAC.TEX, and modified slightly for narrower columns.
 
\chardef\other=12
\def\ttverbatim{\begingroup 
  \catcode`\~=\other \catcode`\_=\other \catcode`\^=\other
  \catcode`\"=\other 
  \obeyspaces \obeylines \tt}
  
\def\ttverbatimplus{%
  \begingroup
  \catcode`\&=\other \catcode`\$=\other \catcode`\%=\other
  \catcode`\~=\other \catcode`\_=\other \catcode`\^=\other
  \catcode`\"=\other \catcode`\#=\other
  \obeyspaces \obeylines \tt}
 
\newskip\ttglue
{\tt \global\ttglue=.5em plus .25em minus .15em}
% this should be installed in each font
 
%       From David Eppstein's ``Trees'' paper (6#1), preserve initial spaces.
{\obeyspaces\gdef {\ifvmode\indent\fi\space}}
 
\newdimen\ttrightskip
\ttrightskip=5pc
 
\newif\ifttVertChar \ttVertCharfalse
{\catcode`\|=\active \gdef\VertChar{\def|{\char"7C }}}
 
%\outer\def\begintt{$$\let\par=\endgraf \ttverbatim \parskip=\z@
\outer\def\begintt{$$\def\par{\leavevmode\null\endgraf}\ttverbatim \parskip=\z@
  \ifttVertChar \VertChar \global\ttVertCharfalse \else \catcode`\|=0 \fi
  \catcode`\|=0 \rightskip=-\ttrightskip \ttfinish}
{\catcode`\|=0 |catcode`|\=\other % | is temporary escape character
  |obeylines % end of line is active
  |gdef|ttfinish#1^^M#2\endtt{#1|vbox{#2}|endgroup$$}}
 
%       Other non-tt elements that may be embedded within \begintt...\endtt .
\def\MTH{$}
\def\sb{_}
\def\sp{^}
\def\SP{{\tt\char"20 }}  % "visible" space
\chardef\bs=`\\
\def\vrt{{\tt\char`\|}}
 
\catcode`\|=\active
%{\obeylines \gdef|{\ttverbatim \spaceskip\ttglue \let^^M=\  \let|=\endgroup}}
{\obeylines \gdef\activatettbar{\global\catcode`\|=\active %
  \gdef|{\ttverbatimplus \spaceskip\ttglue \xspaceskip\ttglue %
         \let^^M=\  \let|=\endgroup}}}
\activatettbar
 
% The active | (which here implements verbatim mode) is redefined in
% such headers as TABLES.TeX and must be able to be reinstated.
% \activatettbar been tested with TABLES.TeX, and the two uses are
% mutually operable (TUGboat 7#2, "Tables in INRSTeX").
